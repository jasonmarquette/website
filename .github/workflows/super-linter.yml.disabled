---
name: Deploy Static HTML Site and app.py

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy with SSH and rsync
        run: |
          mkdir -p "$HOME/.ssh"
          echo "$KNOWN_HOSTS" > "$HOME/.ssh/known_hosts"
          chmod 644 "$HOME/.ssh/known_hosts"

          eval "$(ssh-agent -s)"
          echo "$SSH_PRIVATE_KEY" | ssh-add -

          echo "âœ… Fingerprint of private key:"
          echo "$SSH_PRIVATE_KEY" > keyfile
          chmod 600 keyfile
          ssh-keygen -lf keyfile

          echo "âœ… Keys currently loaded in agent:"
          ssh-add -l

          echo "âœ… REMOTE_USER: $REMOTE_USER"
          echo "âœ… REMOTE_HOST: $REMOTE_HOST"

          echo "âœ… Testing SSH connection:"
          ssh -A -o StrictHostKeyChecking=yes "$REMOTE_USER@$REMOTE_HOST" "echo SSH connection successful"

          echo "ðŸ“¦ Deploying static site..."
          ssh -A -o StrictHostKeyChecking=yes "$REMOTE_USER@$REMOTE_HOST" \
            "mkdir -p '$REMOTE_PATH'"

          rsync -az --delete -e "ssh -A -o StrictHostKeyChecking=yes -o IdentitiesOnly=yes" ./ \
            "$REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH"

          echo "ðŸ“¦ Deploying app.py..."
          rsync -az -e "ssh -A -o StrictHostKeyChecking=yes -o IdentitiesOnly=yes" ./app.py \
            "$REMOTE_USER@$REMOTE_HOST:/home/$REMOTE_USER/app.py"

          ssh -A -o StrictHostKeyChecking=yes "$REMOTE_USER@$REMOTE_HOST" << EOF
            chmod 755 /home/$REMOTE_USER/app.py
            sync
            echo "âœ… Deployment complete:"
            echo "Static site contents:"
            ls -la "$REMOTE_PATH"
            echo "app.py details:"
            ls -la /home/$REMOTE_USER/app.py
          EOF

        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          KNOWN_HOSTS: ${{ secrets.KNOWN_HOSTS }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
