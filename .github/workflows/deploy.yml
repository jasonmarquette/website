name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p "$HOME/.ssh"
          echo "$KNOWN_HOSTS" > "$HOME/.ssh/known_hosts"
          chmod 644 "$HOME/.ssh/known_hosts"

          eval "$(ssh-agent -s)"
          echo "$SSH_PRIVATE_KEY" | ssh-add -

          echo "✅ Fingerprint of private key:"
          ssh-keygen -lf <(echo "$SSH_PRIVATE_KEY")

          echo "✅ Keys currently loaded in agent:"
          ssh-add -l

          echo "✅ Testing SSH connection:"
          ssh -A -o StrictHostKeyChecking=yes "$REMOTE_USER@$REMOTE_HOST" "echo SSH connection successful"

        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          KNOWN_HOSTS: ${{ secrets.KNOWN_HOSTS }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}

      - name: Deploy via SSH and Rsync
        run: |
          echo "Deploying static site..."

          ssh -A -o StrictHostKeyChecking=yes "$REMOTE_USER@$REMOTE_HOST" \
            "mkdir -p '$REMOTE_PATH'"

          rsync -az --delete -e "ssh -A -o StrictHostKeyChecking=yes -o IdentitiesOnly=yes" ./ \
            "$REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH"

          echo "Deploying app.py..."

          rsync -az -e "ssh -A -o StrictHostKeyChecking=yes -o IdentitiesOnly=yes" ./app.py \
            "$REMOTE_USER@$REMOTE_HOST:/home/$REMOTE_USER/app.py"

          ssh -A -o StrictHostKeyChecking=yes "$REMOTE_USER@$REMOTE_HOST" << 'EOF'
            chmod 755 /home/$REMOTE_USER/app.py
            sync
            echo "Deployment complete:"
            echo "Static site contents:"
            ls -la "$REMOTE_PATH"
            echo "app.py details:"
            ls -la /home/$REMOTE_USER/app.py
          EOF

        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
