---
name: Deploy Static HTML Site and app.py (SCP version)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy using SCP
        run: |
          mkdir -p "$HOME/.ssh"
          echo "$KNOWN_HOSTS" > "$HOME/.ssh/known_hosts"
          chmod 644 "$HOME/.ssh/known_hosts"

          eval "$(ssh-agent -s)"
          echo "$SSH_PRIVATE_KEY" | ssh-add -

          echo "‚úÖ SSH connection test:"
          ssh -o StrictHostKeyChecking=yes "$REMOTE_USER@$REMOTE_HOST" "echo SSH connection successful"

          echo "üìÅ Creating remote static site path..."
          ssh -o StrictHostKeyChecking=yes "$REMOTE_USER@$REMOTE_HOST" \
            "mkdir -p '$REMOTE_PATH'"

          echo "üì¶ Deploying static files with SCP..."
          find . -type f \
            ! -path "./.git/*" \
            ! -path "./.github/*" \
            ! -name "app.py" \
            ! -name "keyfile" \
            -exec scp -o StrictHostKeyChecking=yes -o IdentitiesOnly=yes {} "$REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH" \;

          echo "üöÄ Deploying app.py..."
          scp -o StrictHostKeyChecking=yes -o IdentitiesOnly=yes ./app.py \
            "$REMOTE_USER@$REMOTE_HOST:/home/$REMOTE_USER/app.py"

          ssh -o StrictHostKeyChecking=yes "$REMOTE_USER@$REMOTE_HOST" << EOF
            chmod 755 /home/$REMOTE_USER/app.py
            sync
            echo "‚úÖ Deployment complete:"
            echo "Static site contents:"
            ls -la "$REMOTE_PATH"
            echo "app.py details:"
            ls -la /home/$REMOTE_USER/app.py
          EOF

        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          KNOWN_HOSTS: ${{ secrets.KNOWN_HOSTS }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
